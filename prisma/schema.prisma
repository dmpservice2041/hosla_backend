generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  STAFF
  MEMBER
  USER
}

enum PostStatus {
  PUBLISHED
  PENDING_REVIEW
  HIDDEN
  DELETED
}

enum ReportReason {
  ABUSE
  SPAM
  FAKE
  OFFENSIVE
}

enum ReportStatus {
  PENDING
  RESOLVED
  DISMISSED
}

enum FilterSeverity {
  HIGH
  MEDIUM
  LOW
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum EventType {
  IN_PERSON
  ONLINE
}

enum ParticipantStatus {
  GOING
  MAYBE
  NOT_GOING
}

enum ConversationType {
  DIRECT
  GROUP
  COMMUNITY
}

enum MessageStatusType {
  SENT
  DELIVERED
  READ
}

model User {
  id            String    @id @default(uuid())
  phone         String    @unique
  email         String?   @unique
  name          String
  bio           String?
  profilePicUrl String?
  dateOfBirth   DateTime?
  gender        Gender?
  role          Role      @default(USER)
  isActive      Boolean   @default(true)
  isDeleted     Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  refreshTokens     RefreshToken[]
  devices           Device[]
  emergencyContacts EmergencyContact[]
  posts             Post[]
  comments          Comment[]
  likes             Like[]
  reports           Report[]
  savedPosts        SavedPost[]
  createdEvents     Event[]
  eventParticipations EventParticipant[]
  messageStatuses   MessageStatus[]
  createdCommunities Community[] 
  communityMemberships CommunityMember[]
  conversationMembers ConversationMember[]
  messages          Message[]
  blockedUsers      BlockedUser[] @relation("UserBlocked")
  blockedBy         BlockedUser[] @relation("UserBlocker")
  commentLikes      CommentLike[]
  settings          UserSettings?
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  platform  String?
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([platform])
}

model Device {
  id         String   @id @default(uuid())
  userId     String
  fcmToken   String
  platform   String   
  model      String?
  lastActive DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmergencyContact {
  id           String @id @default(uuid())
  userId       String
  name         String
  phone        String
  relationship String

  user         User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Post {
  id             String    @id @default(uuid())
  authorId       String
  title          String?
  body           String
  mediaUrls      String[]
  youtubeVideoId String?
  tags           String[]
  tagPriority    Int      @default(10)
  rolePriority   Int      @default(10)
  status         PostStatus @default(PUBLISHED)
  isPinned       Boolean    @default(false)
  scheduledAt    DateTime?
  publishedAt    DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  author         User      @relation(fields: [authorId], references: [id])
  comments       Comment[]
  likes          Like[]
  reports        Report[]
  savedPosts     SavedPost[]

  @@index([isPinned, tagPriority, rolePriority, publishedAt, id])
  @@index([authorId])
}

model Comment {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  parentId  String?  
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  author    User     @relation(fields: [userId], references: [id])
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  reports   Report[]
  isDeleted Boolean   @default(false)
  likes     CommentLike[]

  @@index([postId])
  @@index([userId])
}

model Like {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
}

model SavedPost {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
}

model Report {
  id         String   @id @default(uuid())
  reporterId String
  postId     String?
  commentId  String?
  reason     ReportReason
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())

  reporter   User     @relation(fields: [reporterId], references: [id])
  post       Post?    @relation(fields: [postId], references: [id])
  comment    Comment? @relation(fields: [commentId], references: [id])
}

model Event {
  id          String   @id @default(uuid())
  creatorId   String
  title       String
  description String
  location    String?
  meetingLink String?
  eventType   EventType
  startsAt    DateTime
  endsAt      DateTime
  maxCapacity Int?
  isCancelled Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator     User     @relation(fields: [creatorId], references: [id])
  participants EventParticipant[]
  reminders   EventReminder[]
}

model EventParticipant {
  id        String            @id @default(uuid())
  eventId   String
  userId    String
  status    ParticipantStatus @default(GOING)
  joinedAt  DateTime          @default(now())

  event     Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
}

model EventReminder {
  id        String   @id @default(uuid())
  eventId   String
  remindAt  DateTime
  isSent    Boolean  @default(false)

  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
}

model Conversation {
  id        String           @id @default(uuid())
  type      ConversationType
  name      String?          
  photoUrl  String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt 

  members   ConversationMember[]
  messages  Message[]
}

model ConversationMember {
  id             String       @id @default(uuid())
  conversationId String
  userId         String
  isAdmin        Boolean      @default(false)
  joinedAt       DateTime     @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
}

model Message {
  id                  String   @id @default(uuid())
  conversationId      String
  senderId            String
  content             String?
  mediaUrl            String?
  voiceUrl            String?
  replyToId           String?
  isDeleted           Boolean  @default(false)
  deletedForEveryone  Boolean  @default(false)
  createdAt           DateTime @default(now())

  conversation        Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender              User         @relation(fields: [senderId], references: [id])
  replyTo             Message?     @relation("ReplyMessage", fields: [replyToId], references: [id])
  replies             Message[]    @relation("ReplyMessage")
  statuses            MessageStatus[]
}

model MessageStatus {
  id        String            @id @default(uuid())
  messageId String
  userId    String
  status    MessageStatusType
  updatedAt DateTime          @updatedAt

  message   Message           @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade) 

  @@unique([messageId, userId])
}

model Community {
  id          String   @id @default(uuid())
  name        String
  description String
  creatorId   String?  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator     User?     @relation(fields: [creatorId], references: [id])
  members     CommunityMember[]
}

model CommunityMember {
  id          String   @id @default(uuid())
  communityId String
  userId      String
  role        Role     @default(USER) 
  joinedAt    DateTime @default(now())

  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([communityId, userId])
}

model UserSettings {
  id                  String   @id @default(uuid())
  userId              String   @unique
  language            String   @default("en")
  fontSize            String   @default("medium") 
  darkMode            Boolean  @default(false)
  notifyEvents        Boolean  @default(true)
  notifyChat          Boolean  @default(true)
  notifyAnnouncements Boolean  @default(true)

  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BlockedUser {
  id        String   @id @default(uuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())

  blocker   User     @relation("UserBlocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked   User     @relation("UserBlocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
}

model BlockedWord {
  id        String         @id @default(uuid())
  word      String         @unique
  severity  FilterSeverity @default(MEDIUM)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  createdBy String?
}

model CommentLike {
  id        String   @id @default(uuid())
  commentId String
  userId    String
  createdAt DateTime @default(now())

  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
}
